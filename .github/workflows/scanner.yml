name: Scanner Crypto ETH/BTC Focus

on:
  schedule:
    # Executa a cada 15 minutos durante horÃ¡rio de trading
    - cron: '*/15 6-23 * * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  crypto-scanner:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    
    steps:
    - name: ğŸ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ”§ Prepare Environment
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip cache purge
        
    - name: ğŸ“¦ Install Core Dependencies
      run: |
        # Instalar numpy primeiro para evitar conflitos
        pip install --no-cache-dir numpy==1.21.6
        
        # Instalar pandas com versÃ£o compatÃ­vel
        pip install --no-cache-dir --no-binary=pandas pandas==1.5.3
        
        # Verificar compatibilidade
        python -c "import numpy as np; import pandas as pd; print(f'NumPy: {np.__version__}, Pandas: {pd.__version__}')"
        
    - name: ğŸ“ˆ Install Analysis Libraries
      run: |
        pip install scikit-learn==1.1.3
        pip install ta==0.10.2
        pip install ccxt==4.2.0
        pip install requests==2.31.0
        pip install python-telegram-bot==20.3
        
    - name: ğŸ” Install Optional Libraries
      continue-on-error: true
      run: |
        pip install pandas-ta==0.3.14b || echo "pandas-ta installation failed, continuing..."
        
    - name: âœ… Verify Installation
      run: |
        python -c "
        import sys
        print('Python version:', sys.version)
        
        required_modules = ['pandas', 'numpy', 'ccxt', 'ta', 'requests']
        for module in required_modules:
            try:
                __import__(module)
                print(f'âœ… {module}: OK')
            except ImportError as e:
                print(f'âŒ {module}: FAILED - {e}')
                sys.exit(1)
        
        # Teste especÃ­fico pandas/numpy
        try:
            import pandas as pd
            import numpy as np
            df = pd.DataFrame({'test': [1, 2, 3]})
            print(f'âœ… Pandas/NumPy compatibility: OK')
        except Exception as e:
            print(f'âŒ Pandas/NumPy compatibility: FAILED - {e}')
            sys.exit(1)
        "
        
    - name: ğŸš€ Run ETH/BTC Scanner
      timeout-minutes: 8
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TZ: 'UTC'
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "ğŸ¯ Iniciando Scanner ETH/BTC Focus..."
        echo "ğŸ“Š Analisando BTC/USDT e ETH/USDT com mÃºltiplos timeframes..."
        echo "â° Executado em: $(date)"
        echo "ğŸ” Timeframes: 1h + 4h"
        echo "ğŸ“ˆ Setups: 10+ configuraÃ§Ãµes avanÃ§adas"
        echo ""
        
        # Executar com tratamento de erro
        if python scanner_github_actions.py; then
            echo "âœ… Scanner executado com sucesso!"
        else
            echo "âŒ Scanner falhou!"
            exit 1
        fi
        
    - name: ğŸ“‹ Debug Info on Failure
      if: failure()
      run: |
        echo "ğŸ” === INFORMAÃ‡Ã•ES DE DEBUG ==="
        echo "ğŸ“… Data/Hora: $(date)"
        echo "ğŸ Python: $(python --version)"
        echo "ğŸ“ DiretÃ³rio: $(pwd)"
        echo "ğŸ“„ Arquivos Python:"
        ls -la *.py || echo "Nenhum arquivo Python encontrado"
        echo ""
        echo "ğŸ“¦ Bibliotecas instaladas:"
        pip list | grep -E "(pandas|numpy|ccxt|ta|requests|telegram)" || echo "Bibliotecas nÃ£o encontradas"
        echo ""
        echo "ğŸ” VariÃ¡veis de ambiente:"
        echo "TELEGRAM configurado: $(env | grep TELEGRAM | wc -l) variÃ¡veis"
        echo ""
        echo "ğŸ’¾ EspaÃ§o em disco:"
        df -h
        echo ""
        echo "ğŸ§  MemÃ³ria:"
        free -h
        
    - name: ğŸ§¹ Cleanup on Failure
      if: failure()
      run: |
        # Limpar cache pip em caso de falha
        pip cache purge || true
        # Remover arquivos temporÃ¡rios
        find . -name "*.pyc" -delete || true
        find . -name "__pycache__" -type d -exec rm -rf {} + || true
